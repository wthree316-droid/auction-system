<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #111; color: #ddd; font-family: monospace; }
        .table { color: #ddd; }
        .btn-xs { padding: 2px 5px; font-size: 0.8rem; }
        .nav-tabs .nav-link { cursor: pointer; }
    </style>
</head>
<body>

    <!-- Login Overlay -->
    <div id="loginOverlay" class="position-fixed top-0 start-0 w-100 h-100 bg-black d-flex justify-content-center align-items-center" style="z-index: 9999;">
        <div class="text-center">
            <h2 class="text-danger mb-3">ADMIN ACCESS ONLY</h2>
            <input type="password" id="adminPass" class="form-control text-center bg-dark text-white border-danger mb-2" placeholder="Enter Password">
            <button class="btn btn-danger w-100" onclick="checkAdmin()">Unlock</button>
        </div>
    </div>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-danger"><i class="bi bi-shield-lock"></i> Admin Dashboard</h3>
            <a href="index.html" class="btn btn-outline-secondary">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs border-secondary mb-3" id="adminTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active text-warning bg-transparent" data-bs-toggle="tab" data-bs-target="#users-tab">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Users (‡πÅ‡∏ö‡∏ô/‡∏•‡∏ö)</button>
            </li>
            <li class="nav-item">
                <button class="nav-link text-info bg-transparent" data-bs-toggle="tab" data-bs-target="#items-tab">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏•‡∏ö)</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- TAB 1: USER MANAGEMENT -->
            <div class="tab-pane fade show active" id="users-tab">
                <div class="alert alert-dark border-secondary small text-secondary">
                    <i class="bi bi-info-circle"></i> <b>‡∏Å‡∏≤‡∏£‡∏•‡∏ö User:</b> ‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà "‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß" ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-striped border-secondary align-middle">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>IP Address</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 2: ITEM MANAGEMENT -->
            <div class="tab-pane fade" id="items-tab">
                <div class="row g-3" id="adminProductList">
                    <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, orderBy, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================
        // ‚ö†Ô∏è ‡∏ß‡∏≤‡∏á Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCQOSvE07bNi2WfCymRdOabDewgYRs4UM4",
            authDomain: "auction-system-e9801.firebaseapp.com",
            projectId: "auction-system-e9801",
            storageBucket: "auction-v2-img-999", 
            messagingSenderId: "1089558422014",
            appId: "1:1089558422014:web:4052e4b6e8f391c5a5a0af"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Admin ---
        window.checkAdmin = function() {
            const pass = document.getElementById('adminPass').value;
            if(pass === "admin123") { // <-- ‡πÅ‡∏Å‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                document.getElementById('loginOverlay').classList.add('d-none');
                loadUsers();
                loadItems();
            } else {
                alert("Wrong Password!");
            }
        }

        // --- 1. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ User ---
        async function loadUsers() {
            const tableBody = document.getElementById('userTableBody');
            const q = query(collection(db, "users"), orderBy("created_at", "desc"));
            const snapshot = await getDocs(q);
            
            tableBody.innerHTML = "";
            snapshot.forEach(docSnap => {
                const u = docSnap.data();
                const isBanned = u.is_banned;
                const created = u.created_at ? new Date(u.created_at.seconds * 1000).toLocaleDateString() : "-";
                
                const html = `
                    <tr>
                        <td class="${isBanned ? 'text-decoration-line-through text-secondary' : 'text-white'} fw-bold">${u.displayName}</td>
                        <td class="text-secondary small">${u.ip_address}</td>
                        <td class="small text-secondary">${created}</td>
                        <td>${isBanned ? '<span class="badge bg-danger">BANNED</span>' : '<span class="badge bg-success">Active</span>'}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-xs ${isBanned ? 'btn-outline-warning' : 'btn-outline-warning text-white'}" 
                                    onclick="toggleBan('${docSnap.id}', ${isBanned})">
                                    <i class="bi bi-slash-circle"></i> ${isBanned ? '‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô' : '‡πÅ‡∏ö‡∏ô'}
                                </button>
                                <button class="btn btn-xs btn-outline-danger" 
                                    onclick="deleteUser('${docSnap.id}', '${u.displayName}')">
                                    <i class="bi bi-trash"></i> ‡∏•‡∏ö
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += html;
            });
        }

        // --- 2. ‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ö‡∏ô/‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô ---
        window.toggleBan = async function(uid, currentStatus) {
            if(!confirm(currentStatus ? "‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô User ‡∏ô‡∏µ‡πâ?" : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô User ‡∏ô‡∏µ‡πâ?")) return;
            
            await updateDoc(doc(db, "users", uid), {
                is_banned: !currentStatus
            });
            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            loadUsers();
        }

        // --- 3. ‡∏•‡∏ö User (‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà Active) üî• ---
        window.deleteUser = async function(uid, name) {
            if(!confirm(`‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!\n\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà "‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß" ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥`)) return;

            try {
                // A. ‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á User ‡∏ô‡∏µ‡πâ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏¢)
                const qItems = query(collection(db, "auctions"), where("seller_uid", "==", uid));
                const itemSnaps = await getDocs(qItems);
                
                let deletedCount = 0;
                const deletePromises = [];

                itemSnaps.forEach(itemDoc => {
                    const data = itemDoc.data();
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≤‡∏¢ (status != 'sold') -> ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
                    if(data.status !== 'sold') {
                        deletePromises.push(deleteDoc(itemDoc.ref));
                        deletedCount++;
                    }
                });

                await Promise.all(deletePromises);

                // B. ‡∏•‡∏ö User ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                await deleteDoc(doc(db, "users", uid));

                alert(`‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n- ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${name}\n- ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏¢: ${deletedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                loadUsers(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                loadItems(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤

            } catch (error) {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            }
        }

        // --- 4. ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Item Tab) ---
        async function loadItems() {
            const container = document.getElementById('adminProductList');
            const q = query(collection(db, "auctions"), orderBy("created_at", "desc"));
            const snapshot = await getDocs(q);

            container.innerHTML = "";
            snapshot.forEach(docSnap => {
                const item = docSnap.data();
                const isSold = item.status === 'sold';
                
                const html = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card p-2 d-flex flex-row align-items-center bg-dark border-secondary position-relative">
                            ${isSold ? '<span class="position-absolute top-0 start-0 badge bg-success m-1">SOLD</span>' : ''}
                            <img src="${item.image_url}" style="width: 60px; height: 60px; object-fit: cover;" class="rounded me-3">
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="text-truncate fw-bold text-white">${item.title}</div>
                                <div class="small text-secondary">‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.current_price}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteItem('${docSnap.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // --- 5. ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô) ---
        window.deleteItem = async function(itemId) {
            if(!confirm("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£? (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)")) return;
            await deleteDoc(doc(db, "auctions", itemId));
            loadItems();
        }

    </script>
</body>
</html>