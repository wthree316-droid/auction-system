<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการประมูล - Auction History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; }
        .card { background-color: #1a1a1a; border: 1px solid #333; color: white; opacity: 0.9; transition: transform 0.2s; }
        .card:hover { opacity: 1; border-color: #666; transform: translateY(-2px); }
        .product-img-list { height: 180px; object-fit: cover; width: 100%; filter: grayscale(30%); }
        .winner-badge { background: gold; color: black; font-weight: bold; padding: 2px 8px; border-radius: 4px; }
        
        /* Loading Overlay */
        #loadingSpinner { display: block; } /* เริ่มต้นให้โชว์ก่อน */
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-black border-bottom border-secondary mb-4 sticky-top">
        <div class="container">
            <a href="index.html" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="bi bi-arrow-left"></i> กลับหน้าประมูล
            </a>
            <span class="navbar-brand mb-0 h1 text-secondary mx-auto pe-5">ประวัติสินค้าที่ปิดแล้ว</span>
        </div>
    </nav>

    <div class="container pb-5">
        <!-- Loading -->
        <div id="loadingSpinner" class="text-center mt-5">
            <div class="spinner-border text-secondary" role="status"></div>
            <p class="text-secondary mt-2">กำลังยืนยันตัวตนและโหลดข้อมูล...</p>
        </div>

        <!-- List -->
        <div class="row g-3" id="historyList"></div>
    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // ✅ เพิ่ม Auth Import เพื่อแก้ปัญหา Permission Denied
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        // ⚠️ Config (ใช้ชุดเดียวกับ app.js)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCQOSvE07bNi2WfCymRdOabDewgYRs4UM4",
            authDomain: "auction-system-e9801.firebaseapp.com",
            projectId: "auction-system-e9801",
            storageBucket: "auction-v2-img-999", 
            messagingSenderId: "1089558422014",
            appId: "1:1089558422014:web:4052e4b6e8f391c5a5a0af"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // ✅ สร้าง Auth Instance

        // 1. เริ่มระบบ Login ก่อนโหลดข้อมูล
        signInAnonymously(auth).catch((error) => {
            console.error("Login Error:", error);
            document.getElementById('loadingSpinner').innerHTML = `<p class='text-danger'>เข้าสู่ระบบไม่สำเร็จ: ${error.message}</p>`;
        });

        // 2. รอจนกว่าจะ Login เสร็จ ค่อยโหลดข้อมูล
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Login ผ่านแล้ว -> โหลดข้อมูลได้
                loadHistory();
            }
        });

        async function loadHistory() {
            const listContainer = document.getElementById('historyList');
            const spinner = document.getElementById('loadingSpinner');
            const now = new Date().getTime();

            try {
                // ดึงข้อมูลทั้งหมดมาเรียง
                const q = query(collection(db, "auctions"), orderBy("created_at", "desc"));
                const snapshot = await getDocs(q);
                
                spinner.style.display = 'none'; // ซ่อน Spinner
                listContainer.innerHTML = "";
                
                let count = 0;

                snapshot.forEach(doc => {
                    const item = doc.data();
                    // เงื่อนไข: ขายแล้ว (sold) หรือ หมดเวลา (expired)
                    const isSold = item.status === 'sold';
                    const isExpired = item.end_time_ms && now > item.end_time_ms;

                    // โชว์เฉพาะที่จบแล้ว
                    if (isSold || isExpired) {
                        count++;
                        let statusText, badgeClass;
                        
                        if (isSold) {
                            statusText = "ขายแล้ว";
                            badgeClass = "bg-success";
                        } else {
                            statusText = "หมดเวลา";
                            badgeClass = "bg-secondary";
                        }

                        const priceLabel = isSold ? "จบที่ราคา" : "ราคาล่าสุด";
                        
                        // แปลงวันที่
                        let dateStr = "-";
                        if(item.end_time_ms) {
                            dateStr = new Date(item.end_time_ms).toLocaleDateString('th-TH', {
                                day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit'
                            });
                        }

                        // เช็คชื่อผู้ชนะ (ถ้ามี)
                        let winnerInfo = "";
                        if (isSold && item.buyer_uid) {
                            // จริงๆ ควรดึงชื่อผู้ซื้อมาโชว์ แต่เพื่อความเร็วใช้ข้อความไปก่อน
                            winnerInfo = `<div class="mt-2 pt-2 border-top border-secondary small text-warning"><i class="bi bi-trophy-fill"></i> มีผู้ชนะประมูล</div>`;
                        }

                        const html = `
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="card h-100 position-relative">
                                    <div class="position-absolute top-0 end-0 p-2">
                                        <span class="badge ${badgeClass}">${statusText}</span>
                                    </div>
                                    <img src="${item.image_url}" class="card-img-top product-img-list" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-truncate text-white mb-1">${item.title}</h6>
                                        <p class="card-text fw-bold text-danger mb-1">${priceLabel}: ฿${item.current_price.toLocaleString()}</p>
                                        <small class="text-secondary" style="font-size: 0.75rem;">
                                            <i class="bi bi-calendar-event"></i> ปิดเมื่อ: ${dateStr}
                                        </small>
                                        ${winnerInfo}
                                    </div>
                                </div>
                            </div>
                        `;
                        listContainer.innerHTML += html;
                    }
                });

                if(count === 0) {
                    listContainer.innerHTML = `
                        <div class="col-12 text-center text-secondary mt-5 opacity-50">
                            <i class="bi bi-inbox display-1"></i>
                            <p class="mt-3">ยังไม่มีประวัติสินค้าที่จบประมูล</p>
                        </div>`;
                }

            } catch (error) {
                console.error("History Load Error:", error);
                spinner.innerHTML = `<p class="text-danger">เกิดข้อผิดพลาด: ${error.message}<br><small>(ตรวจสอบ Console เพื่อดูรายละเอียด)</small></p>`;
            }
        }
    </script>
</body>
</html>
