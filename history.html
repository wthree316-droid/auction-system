<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการประมูล - Auction History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; }
        .card { background-color: #1a1a1a; border: 1px solid #333; color: white; opacity: 0.9; }
        .product-img-list { height: 180px; object-fit: cover; width: 100%; filter: grayscale(30%); }
        
        /* Status Log สำหรับดูว่าค้างตรงไหน */
        #statusLog { font-size: 0.8rem; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-black border-bottom border-secondary mb-4 sticky-top">
        <div class="container">
            <a href="index.html" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="bi bi-arrow-left"></i> กลับหน้าประมูล
            </a>
            <span class="navbar-brand mb-0 h1 text-secondary mx-auto pe-5">ประวัติสินค้า</span>
        </div>
    </nav>

    <div class="container pb-5">
        <!-- Loading Section -->
        <div id="loadingSection" class="text-center mt-5">
            <div class="spinner-border text-secondary mb-2" role="status"></div>
            <h5 id="loadingText" class="text-secondary">กำลังเริ่มต้นระบบ...</h5>
            <div id="statusLog">Waiting for script...</div>
        </div>

        <!-- Content List -->
        <div class="row g-3" id="historyList"></div>
    </div>

    <!-- Script -->
    <script type="module">
        // ฟังก์ชันช่วยแสดงสถานะ (Debug)
        function updateStatus(msg, isError = false) {
            const logEl = document.getElementById('statusLog');
            const textEl = document.getElementById('loadingText');
            console.log(msg);
            if(logEl) logEl.innerText = msg;
            if(textEl && isError) {
                textEl.innerText = "เกิดข้อผิดพลาด!";
                textEl.className = "text-danger";
                document.querySelector('.spinner-border').style.display = 'none';
            }
        }

        updateStatus("Importing Libraries...");

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        // ⚠️ Config (ต้องตรงกับ app.js)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCQOSvE07bNi2WfCymRdOabDewgYRs4UM4",
            authDomain: "auction-system-e9801.firebaseapp.com",
            projectId: "auction-system-e9801",
            storageBucket: "auction-v2-img-999", 
            messagingSenderId: "1089558422014",
            appId: "1:1089558422014:web:4052e4b6e8f391c5a5a0af"
        };

        updateStatus("Initializing Firebase...");
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // 1. เริ่มระบบ Login
        updateStatus("Attempting to login...");
        signInAnonymously(auth).catch((error) => {
            updateStatus("Login Failed: " + error.message, true);
        });

        // 2. รอฟังผล Login
        let dataLoaded = false;
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (!dataLoaded) { // โหลดแค่ครั้งเดียวพอ
                    updateStatus(`Logged in as ${user.uid.slice(0,5)}... Loading Data...`);
                    loadHistory();
                    dataLoaded = true;
                }
            } else {
                updateStatus("User signed out...");
            }
        });

        async function loadHistory() {
            const listContainer = document.getElementById('historyList');
            const loadingSection = document.getElementById('loadingSection');
            const now = new Date().getTime();

            try {
                // ดึงข้อมูล
                updateStatus("Querying Firestore...");
                const q = query(collection(db, "auctions"), orderBy("created_at", "desc"));
                const snapshot = await getDocs(q);
                
                updateStatus(`Got ${snapshot.size} items. Rendering...`);
                
                // ซ่อน Loading
                loadingSection.style.display = 'none';
                listContainer.innerHTML = "";
                
                let count = 0;

                snapshot.forEach(doc => {
                    const item = doc.data();
                    const isSold = item.status === 'sold';
                    const isExpired = item.end_time_ms && now > item.end_time_ms;

                    // โชว์เฉพาะที่จบแล้ว (ขายแล้ว หรือ หมดเวลา)
                    if (isSold || isExpired) {
                        count++;
                        let statusText, badgeClass;
                        
                        if (isSold) {
                            statusText = "ขายแล้ว";
                            badgeClass = "bg-success";
                        } else {
                            statusText = "หมดเวลา";
                            badgeClass = "bg-secondary";
                        }

                        const priceLabel = isSold ? "จบที่ราคา" : "ราคาล่าสุด";
                        
                        let dateStr = "-";
                        if(item.end_time_ms) {
                            dateStr = new Date(item.end_time_ms).toLocaleDateString('th-TH', {
                                day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit'
                            });
                        }

                        let winnerInfo = "";
                        if (isSold && item.buyer_uid) {
                            winnerInfo = `<div class="mt-2 pt-2 border-top border-secondary small text-warning"><i class="bi bi-trophy-fill"></i> มีผู้ชนะประมูล</div>`;
                        }

                        const html = `
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="card h-100 position-relative">
                                    <div class="position-absolute top-0 end-0 p-2">
                                        <span class="badge ${badgeClass}">${statusText}</span>
                                    </div>
                                    <img src="${item.image_url}" class="card-img-top product-img-list" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                                    <div class="card-body p-2">
                                        <h6 class="card-title text-truncate text-white mb-1">${item.title}</h6>
                                        <p class="card-text fw-bold text-danger mb-1">${priceLabel}: ฿${item.current_price.toLocaleString()}</p>
                                        <small class="text-secondary" style="font-size: 0.75rem;">
                                            <i class="bi bi-calendar-event"></i> ปิดเมื่อ: ${dateStr}
                                        </small>
                                        ${winnerInfo}
                                    </div>
                                </div>
                            </div>
                        `;
                        listContainer.innerHTML += html;
                    }
                });

                if(count === 0) {
                    listContainer.innerHTML = `
                        <div class="col-12 text-center text-secondary mt-5 opacity-50">
                            <i class="bi bi-inbox display-1"></i>
                            <p class="mt-3">ยังไม่มีประวัติสินค้าที่จบประมูล</p>
                        </div>`;
                }

            } catch (error) {
                updateStatus("Data Load Error: " + error.message, true);
                // แสดง Error บนหน้าจอแทน Loading
                loadingSection.style.display = 'block';
            }
        }
    </script>
</body>
</html>
