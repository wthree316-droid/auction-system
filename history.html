<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="index.css">
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-glass sticky-top py-3 mb-5">
        <div class="container">
            <a href="index.html" class="btn btn-light rounded-pill px-3 shadow-sm d-flex align-items-center gap-2 text-secondary fw-bold" style="background: #fff;">
                <i class="bi bi-arrow-left"></i> <span>หน้าหลัก</span>
            </a>
            <div class="d-flex align-items-center gap-2 mx-auto me-md-0"> 
                <div class="rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 40px; height: 40px; background: linear-gradient(135deg, #feca57 0%, #ff9f43 100%);">
                    <i class="bi bi-clock-history text-white"></i>
                </div>
                <span class="navbar-brand mb-0 h4">HISTORY</span>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="row g-4 mb-5 justify-content-center">
            <div class="col-md-4">
                <div class="stat-card stat-sold">
                    <div class="stat-icon bg-success-subtle text-success"><i class="bi bi-lightning-fill"></i></div>
                    <h3 class="fw-bold text-dark mb-0" id="statSoldItems">0</h3>
                    <small class="text-secondary text-uppercase d-block mt-1">รายการขายสด (Sold)</small>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stat-card stat-revenue" style="background: #fff;"> 
                    <div class="stat-icon bg-danger-subtle text-danger"><i class="bi bi-cash-stack"></i></div>
                    <h2 class="fw-bold text-danger mb-0" id="statTotalRevenue">฿0</h2>
                    <small class="text-secondary text-uppercase d-block mt-1 fw-bold">ยอดขายรวมทั้งหมด</small>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="stat-card stat-auction">
                    <div class="stat-icon bg-warning-subtle text-warning"><i class="bi bi-trophy-fill"></i></div>
                    <h3 class="fw-bold text-dark mb-0" id="statAuctionItems">0</h3>
                    <small class="text-secondary text-uppercase d-block mt-1">จบประมูล (Won)</small>
                </div>
            </div>
        </div>

        <div id="loadingSection" class="text-center py-5">
            <div class="spinner-border text-warning mb-3" role="status"></div>
            <p class="text-secondary">กำลังดึงข้อมูลประวัติ...</p>
        </div>

        <div id="historyContent" style="display: none;">
            
            <div class="mb-5">
                <div class="d-flex align-items-center justify-content-between mb-4 pb-2 border-bottom">
                    <h5 class="section-title text-success">
                        <i class="bi bi-check-circle-fill"></i> รายการที่ขายสด (Sold)
                    </h5>
                    <span class="count-badge" id="badgeSoldCount">0</span>
                </div>
                <div class="row g-4" id="soldList"></div>
                <div id="msgNoSold" class="text-center py-5 d-none opacity-50">
                    <i class="bi bi-basket display-4 text-secondary mb-3"></i>
                    <p class="text-secondary">ยังไม่มีรายการขายสด</p>
                </div>
            </div>

            <div class="mb-5">
                <div class="d-flex align-items-center justify-content-between mb-4 pb-2 border-bottom">
                    <h5 class="section-title text-warning">
                        <i class="bi bi-trophy"></i> รายการที่จบประมูล (Won)
                    </h5>
                    <span class="count-badge" id="badgeAuctionCount">0</span>
                </div>
                <div class="row g-4" id="auctionList"></div>
                 <div id="msgNoAuction" class="text-center py-5 d-none opacity-50">
                    <i class="bi bi-hourglass-split display-4 text-secondary mb-3"></i>
                    <p class="text-secondary">ไม่มีรายการประมูลที่จบแล้ว</p>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="historyDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content position-relative">
                <button type="button" class="btn-close-modal" data-bs-dismiss="modal"><i class="bi bi-x-lg"></i></button>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <div class="col-md-6 d-flex align-items-center justify-content-center bg-light position-relative" style="min-height: 350px;">
                            <div id="detailImageOverlay"></div>
                            <img id="detailImage" src="" class="img-fluid p-3" style="max-height: 350px; object-fit: contain;">
                        </div>
                        <div class="col-md-6 p-4 d-flex flex-column bg-white">
                            <div class="mb-3">
                                <span id="detailStatusBadge" class="badge rounded-pill mb-2">STATUS</span>
                                <h4 class="fw-bold mb-1 text-dark" id="detailTitle">...</h4>
                                <small class="text-secondary" id="detailDate"><i class="bi bi-calendar3"></i> -</small>
                            </div>

                            <div class="py-3 px-3 border rounded-3 mb-4 bg-light">
                                <div class="row text-center align-items-center">
                                    <div class="col-6 border-end">
                                        <small class="text-secondary d-block text-uppercase" style="font-size:0.7rem;">ราคาจบ</small>
                                        <span class="h4 text-danger fw-bold mb-0" id="detailPrice">฿0</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-secondary d-block text-uppercase" style="font-size:0.7rem;">ผู้ชนะ</small>
                                        <div id="detailWinnerSection">
                                            <span class="fw-bold text-dark" id="detailWinner">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-auto">
                                <small class="text-secondary fw-bold mb-2 d-block text-uppercase">รายละเอียดสินค้า</small>
                                <p class="text-muted small mb-0" id="detailDesc" style="white-space: pre-line; line-height: 1.6;">...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> 
    
    <script type="module">
        import { AuthService, AuctionService, UserService } from "./api.js";

        function initHistoryPage() {
            AuthService.onUserChange((user) => {
                if (user) loadHistory();
                else AuthService.loginAnonymous().catch(console.error);
            });
        }

        async function loadHistory() {
            const soldListContainer = document.getElementById('soldList');
            const auctionListContainer = document.getElementById('auctionList');
            const loadingSection = document.getElementById('loadingSection');
            const historyContent = document.getElementById('historyContent');

            if (!soldListContainer || !auctionListContainer) return;

            const now = new Date().getTime();

            try {
                // ✅ api.js ส่ง Array กลับมาโดยตรง (ตั้งชื่อว่า items เพื่อความชัดเจน)
                AuctionService.subscribeAllAuctions(async (items) => {
                        
                    soldListContainer.innerHTML = "";
                    auctionListContainer.innerHTML = "";
                    
                    let soldCount = 0;
                    let auctionCount = 0;
                    let totalRevenue = 0;
                    let promises = [];

                    // ✅ Loop ผ่าน Array ตรงๆ ไม่ต้อง .data()
                    items.forEach(item => {
                        const isStatusSold = item.status === 'sold';
                        
                        // ✅ แปลง ISO String จาก Supabase เป็น Milliseconds
                        const endTimeMs = item.end_time ? new Date(item.end_time).getTime() : 0;
                        const isExpired = endTimeMs > 0 && now > endTimeMs;
                        
                        let isBuyNow = isStatusSold; 
                        // เช็คว่ามีคนบิดไหม (ดูจาก last_bidder_uid หรือต้องดึง bids มาดู แต่เบื้องต้นถ้า logic backend update last_bidder ก็ใช้ได้)
                        // หมายเหตุ: ในตาราง auctions ของคุณควรมี field เก็บคนชนะล่าสุด หรือต้อง query แยก
                        // สมมติว่า item มี field 'winner_id' หรือ 'seller_id' (เช็ค Logic Backend ดีๆ)
                        // เพื่อให้ง่าย Frontend assume ว่าถ้าจบเวลาแล้วไม่ Sold คือ Won (ถ้ามีคนบิด)
                        
                        // *สมมติว่า backend ยังไม่ได้เก็บ winner_id ใน table auctions*
                        // เราอาจจะโชว์ไปก่อน หรือต้องไป fetch bids (ซึ่งจะหนัก)
                        // ในที่นี้ขอ assume ว่า ถ้า expired = จบประมูล
                        
                        let isAuctionWin = !isStatusSold && isExpired; 

                        let targetContainer = null;

                        if (isBuyNow) {
                            targetContainer = soldListContainer;
                            soldCount++;
                            totalRevenue += (item.current_price || item.buy_now_price || 0);
                        } else if (isAuctionWin) {
                            targetContainer = auctionListContainer;
                            auctionCount++;
                            totalRevenue += (item.current_price || 0);
                        }

                        if (targetContainer) {
                            const col = document.createElement('div');
                            col.className = "col-12 col-md-6 col-lg-4 col-xl-3";
                            
                            let badgeHtml = isBuyNow ? 
                                `<span class="status-badge bg-sold">SOLD</span>` : 
                                `<span class="status-badge bg-won">WON</span>`;
                            
                            let overlayHtml = isBuyNow ? 
                                `<div class="overlay-badge"><div class="text-stamp stamp-sold">SOLD</div></div>` :
                                `<div class="overlay-badge"><div class="text-stamp stamp-won">WON</div></div>`;
                            
                            let priceColor = isBuyNow ? "text-success" : "text-warning";
                            let dateStr = item.end_time ? new Date(item.end_time).toLocaleDateString('th-TH') : "-";
                            let showPrice = (item.current_price || item.buy_now_price || 0).toLocaleString();

                            col.innerHTML = `
                                <div class="card-history h-100 position-relative" style="cursor: pointer;">
                                    <div class="product-img-wrapper">
                                        ${overlayHtml}
                                        <img src="${item.image_url}" class="product-img-list" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                                        ${badgeHtml}
                                    </div>
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-truncate text-dark mb-1 fw-bold" style="max-width: 90%;">${item.title}</h6>
                                        <p class="card-text fw-bold ${priceColor} mb-3 h5">฿${showPrice}</p>
                                        
                                        <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                                            <div id="winner-${item.id}">
                                                <span class="spinner-border spinner-border-sm text-secondary" style="width:0.7rem; height:0.7rem;"></span>
                                            </div>
                                            <small class="text-secondary" style="font-size: 0.75rem;"><i class="bi bi-clock"></i> ${dateStr}</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // ส่ง endTimeMs ที่แปลงแล้วเข้าไป
                            col.querySelector('.card-history').onclick = () => openHistoryDetail(item, item.id, isBuyNow, endTimeMs);
                            targetContainer.appendChild(col);

                            // --- Fetch Winner Logic ---
                            // หมายเหตุ: ตรงนี้ถ้า DB ไม่ได้เก็บ winner_id ไว้ที่ auctions จะลำบาก
                            // สมมติว่า field ชื่อ winner_id (ถ้าไม่มีอาจต้องแก้ Backend ให้ update field นี้ตอนจบ)
                            const winnerUid = item.winner_id || item.buyer_id; 
                            
                            if (winnerUid) {
                                promises.push(
                                    // ✅ api.js คืนค่า userProfile Object หรือ null
                                    UserService.getUserProfile(winnerUid).then(userProfile => {
                                        // ✅ เรียกใช้ .username ได้เลย ไม่ต้อง .data()
                                        const winnerName = userProfile ? userProfile.username : "Unknown";
                                        const winnerEl = document.getElementById(`winner-${item.id}`);
                                        if (winnerEl) {
                                            if(isBuyNow) {
                                                winnerEl.innerHTML = `<div class="winner-tag silver"><i class="bi bi-bag-check-fill"></i> ${winnerName}</div>`;
                                            } else {
                                                winnerEl.innerHTML = `<div class="winner-tag gold"><i class="bi bi-trophy-fill"></i> ${winnerName}</div>`;
                                            }
                                            item.winner_name_cache = winnerName; 
                                        }
                                    }).catch(err => {
                                        const winnerEl = document.getElementById(`winner-${item.id}`);
                                        if (winnerEl) winnerEl.innerHTML = `<div class="winner-tag silver">Error</div>`;
                                    })
                                );
                            } else {
                                const winnerEl = document.getElementById(`winner-${item.id}`);
                                if (winnerEl) winnerEl.innerHTML = `<div class="winner-tag silver">-</div>`;
                            }
                        }
                    });

                    if(loadingSection) loadingSection.style.display = 'none';
                    if(historyContent) historyContent.style.display = 'block';

                    document.getElementById('statSoldItems').innerText = soldCount;
                    document.getElementById('statAuctionItems').innerText = auctionCount;
                    document.getElementById('statTotalRevenue').innerText = `฿${totalRevenue.toLocaleString()}`;
                    
                    document.getElementById('badgeSoldCount').innerText = soldCount;
                    document.getElementById('badgeAuctionCount').innerText = auctionCount;

                    const msgNoSold = document.getElementById('msgNoSold');
                    const msgNoAuction = document.getElementById('msgNoAuction');
                    
                    if (soldCount === 0) msgNoSold.classList.remove('d-none');
                    else msgNoSold.classList.add('d-none');
                    
                    if (auctionCount === 0) msgNoAuction.classList.remove('d-none');
                    else msgNoAuction.classList.add('d-none');

                    await Promise.all(promises);
                });

            } catch (error) {
                console.error("Load History Error:", error);
                if(loadingSection) loadingSection.innerHTML = `<p class="text-center text-danger">เกิดข้อผิดพลาด: ${error.message}</p>`;
            }
        }

        function openHistoryDetail(item, id, isBuyNow, endTimeMs) {
            const detailModal = new bootstrap.Modal(document.getElementById('historyDetailModal'));
            document.getElementById('detailTitle').innerText = item.title;
            document.getElementById('detailImage').src = item.image_url;
            
            let showPrice = item.current_price || item.buy_now_price || 0;
            document.getElementById('detailPrice').innerText = `฿${showPrice.toLocaleString()}`;
            
            // ใช้ endTimeMs ที่ส่งเข้ามา
            document.getElementById('detailDate').innerText = "สิ้นสุดเมื่อ: " + new Date(endTimeMs).toLocaleString('th-TH');
            document.getElementById('detailDesc').innerText = item.description || "ไม่มีรายละเอียดเพิ่มเติม";
            
            const overlayContainer = document.getElementById('detailImageOverlay');
            const winnerEl = document.getElementById('detailWinner');
            const statusBadge = document.getElementById('detailStatusBadge');
            let winnerName = item.winner_name_cache || "Unknown"; 

            if (isBuyNow) {
                overlayContainer.innerHTML = '<div class="text-stamp stamp-sold position-absolute top-50 start-50 translate-middle" style="z-index:10;">SOLD</div>';
                statusBadge.innerText = "SOLD (ซื้อสด)";
                statusBadge.className = "badge bg-success mb-2 rounded-pill";
                winnerEl.className = "text-dark fw-bold";
            } else {
                overlayContainer.innerHTML = '<div class="text-stamp stamp-won position-absolute top-50 start-50 translate-middle" style="z-index:10;">WON</div>';
                statusBadge.innerText = "AUCTION WON";
                statusBadge.className = "badge bg-warning text-dark mb-2 rounded-pill";
                winnerEl.className = "text-warning fw-bold";
            }
            winnerEl.innerText = winnerName;

            detailModal.show();
        }

        document.addEventListener('DOMContentLoaded', initHistoryPage);
    </script>
</body>
</html>
